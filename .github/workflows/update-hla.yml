name: Update HLA

on:
  push:
    branches: [ master ]
  # workflow_dispatch:
  # schedule:
    # - cron: '0 0 * * 0'

jobs:
  # scheduled:
  refresh:
    name: Refresh HLA sequences
    runs-on: ubuntu-latest
    steps:
        - uses: actions/checkout@v2
        - uses: actions/setup-python@v2
          with:
            python-version: '3.6'
        - name: Install requirements
          run: |
            python3 -m pip install -r requirements.txt
        - name: Download HLA FASTA
          run: |
            make build/hla.fasta
        - name: Update HLA sequences
          id: check_files
          run: |
            echo "========== refreshing sequences =========="
            make refresh-hla-seqs
            echo "========== checking for updates =========="
            FNAME=$(git diff --name-only ontology/chain-sequence.tsv)
            if [[ $FNAME == ontology/chain-sequence.tsv ]]; then
              echo "chain-sequence has an update!"
              echo "::set-output name=run_job::true"
            else
              echo "no new HLA sequences to commit"
              echo "::set-output name=run_job::false"
            fi
        - name: Set date
          run: echo "TODAY=$(date '+%Y-%m-%d')" >> $TODAY
        - name: Test output 
          if: steps.check_files.outputs.run_job == 'true'
          run: echo "Creating a new PR"
        - name: Create pull request
          if: steps.check_files.outputs.run_job == 'true'
          uses: peter-evans/create-pull-request@v3
          with:
            title: ${{ env.TODAY }} HLA Sequence Update
